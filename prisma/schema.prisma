// Prisma Schema - Pulse IA
// Database: PostgreSQL
// @see .github/agents/Master.agent.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTHENTICATION
// ===========================================

model User {
  id            String    @id @default(cuid())
  matricula     String    @unique
  email         String    @unique
  nome          String
  cpfHash       String    // Hashed CPF for security
  cargo         String?
  departamento  String?
  role          Role      @default(COLABORADOR)
  ativo         Boolean   @default(true)
  dataAdmissao  DateTime?
  
  // Relations
  chatSessions  ChatSession[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

enum Role {
  COLABORADOR
  RH
  ADMIN
}

// ===========================================
// CHAT & AI CONVERSATIONS
// ===========================================

model ChatSession {
  id          String    @id @default(cuid())
  userId      String
  titulo      String?   // Auto-generated from first message
  status      SessionStatus @default(ATIVA)
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@map("chat_sessions")
}

enum SessionStatus {
  ATIVA
  ENCERRADA
  TRANSFERIDA // Transferred to human agent
}

model ChatMessage {
  id          String    @id @default(cuid())
  sessionId   String
  role        MessageRole
  content     String
  metadata    Json?     // For storing AI context, tokens used, etc.
  
  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())

  @@index([sessionId])
  @@map("chat_messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ===========================================
// AUDIT LOG (For compliance and monitoring)
// ===========================================

model AuditLog {
  id          String    @id @default(cuid())
  userId      String?
  action      String    // e.g., "LOGIN", "VACATION_REQUEST", "CHAT_MESSAGE"
  resource    String?   // e.g., "ChatSession", "User"
  resourceId  String?
  metadata    Json?     // Additional context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
