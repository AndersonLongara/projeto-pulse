// Prisma Schema - Pulse IA
// Database: SQLite (MVP)
// @see .github/agents/Master.agent.md

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
}

// ===========================================
// USER & AUTHENTICATION
// ===========================================

model User {
  id            String    @id @default(cuid())
  matricula     String    @unique
  email         String    @unique
  nome          String
  passwordHash  String    // Hashed password for authentication
  cpfHash       String?   // Hashed CPF for security (optional for admin users)
  cargo         String?
  departamento  String?
  role          String    @default("USER") // SUPER_ADMIN, ADMIN, USER
  ativo         Boolean   @default(true)
  dataAdmissao  DateTime?
  avatarUrl     String?
  
  // Relations
  chatSessions     ChatSession[]
  assignedSessions ChatSession[] @relation("AssignedAdmin")
  sentMessages     ChatMessage[] @relation("MessageSender")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

// ===========================================
// CHAT & AI CONVERSATIONS
// ===========================================

model ChatSession {
  id              String    @id @default(cuid())
  userId          String
  titulo          String?   // Auto-generated from first message
  status          String    @default("ACTIVE_IA") // ACTIVE_IA, WAITING_HUMAN, HUMAN_INTERVENTION
  assignedAdminId String?   // Admin who took over the conversation
  
  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedAdmin User?     @relation("AssignedAdmin", fields: [assignedAdminId], references: [id])
  messages      ChatMessage[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("chat_sessions")
}

model ChatMessage {
  id          String    @id @default(cuid())
  sessionId   String
  senderType  String    // USER, AI, ADMIN
  senderId    String?   // User ID who sent the message (null for AI)
  content     String
  metadata    String?   // JSON string for storing AI context, tokens used, etc.
  
  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender      User?       @relation("MessageSender", fields: [senderId], references: [id])
  
  createdAt   DateTime  @default(now())

  @@index([sessionId])
  @@index([senderType])
  @@map("chat_messages")
}

// ===========================================
// AUDIT LOG (For compliance and monitoring)
// ===========================================

model AuditLog {
  id          String    @id @default(cuid())
  userId      String?
  action      String    // e.g., "LOGIN", "VACATION_REQUEST", "CHAT_MESSAGE", "INTERVENTION_START"
  resource    String?   // e.g., "ChatSession", "User"
  resourceId  String?
  metadata    String?   // JSON string for additional context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
